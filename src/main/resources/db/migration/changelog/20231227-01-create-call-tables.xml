<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">
    <changeSet id="create-tables" author="elmurod">
        <preConditions onFail="MARK_RAN">
            <dbms type="postgresql"/>
        </preConditions>
        <sql>
            -- warehouse-schema-1
            CREATE TABLE categories
            (
                id          BIGSERIAL PRIMARY KEY NOT NULL,
                name        VARCHAR(255)          NOT NULL,
                description VARCHAR(1000),
                created_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_by  VARCHAR(255)
            );

            ALTER TABLE categories
                ADD CONSTRAINT uk_categories_name UNIQUE (name);

-- warehouse-schema-2
            CREATE TABLE products
            (
                id          BIGSERIAL PRIMARY KEY NOT NULL,
                name        VARCHAR(255)          NOT NULL,
                sku         VARCHAR(128)          NOT NULL,
                category_id BIGINT                NOT NULL,
                created_at  TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_by  VARCHAR(255)
            );

            ALTER TABLE products
                ADD CONSTRAINT uk_products_sku UNIQUE (sku);

            ALTER TABLE products
                ADD CONSTRAINT uk_products_name UNIQUE (name);

            ALTER TABLE products
                ADD CONSTRAINT fk_products_category FOREIGN KEY (category_id)
                    REFERENCES categories (id);

            CREATE INDEX idx_products_category
                ON products (category_id);

-- warehouse-schema-3
            CREATE TABLE warehouse_remain
            (
                id         BIGSERIAL PRIMARY KEY NOT NULL,
                product_id BIGINT                NOT NULL,
                quantity   BIGINT    DEFAULT 0,
                updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                updated_by VARCHAR(255)
            );

            ALTER TABLE warehouse_remain
                ADD CONSTRAINT uk_remain_product UNIQUE (product_id);

            ALTER TABLE warehouse_remain
                ADD CONSTRAINT fk_remain_product FOREIGN KEY (product_id)
                    REFERENCES products (id);

            CREATE INDEX idx_remain_product
                ON warehouse_remain (product_id);

-- warehouse-schema-4
            CREATE TABLE stock_movements
            (
                id            BIGSERIAL PRIMARY KEY NOT NULL,
                product_id    BIGINT                NOT NULL,
                movement_type VARCHAR(16)           NOT NULL,
                quantity      BIGINT                NOT NULL,
                before_qty    BIGINT,
                after_qty     BIGINT,
                created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                created_by    VARCHAR(255)
            );

            ALTER TABLE stock_movements
                ADD CONSTRAINT fk_movements_product FOREIGN KEY (product_id)
                    REFERENCES products (id);

            CREATE INDEX idx_movements_product
                ON stock_movements (product_id);

            CREATE INDEX idx_movements_type
                ON stock_movements (movement_type);

        </sql>
    </changeSet>
</databaseChangeLog>